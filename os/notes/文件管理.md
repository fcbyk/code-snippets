## 初识文件管理
> 文件的定义：一组有意义的信息的集合
文件的属性；文件名、标识符、类型、位置、大小、保护信息...
操作系统应向上提供哪些功能（create、delete、read、write、open、close系统调用）

### 文件的逻辑结构
> 文件内部应该如何被组织起来

**无结构文件**

- 由二进制流或字符流组成，无明显的逻辑结构

**有结构文件**

- 由记录组成，分为定长记录、可变长记录
- 逻辑结构
   - 顺序文件
      - 串结构：记录顺序与关键字无关
      - 顺序结构：记录按关键字顺序排列
      - 可变长记录的顺序文件无法实现随机存取，定长记录可以
      - 定长记录、顺序结构的顺序文件可以快速检索（根据关键字快速找到记录）
      - 最大缺点：不方便 增加/删除 记录
   - 索引文件
      - 建立一张索引表，每个记录对应一个表项。各记录不用保持顺序，方便增加/删除记录
      - 索引表本身就是定长记录顺序文件，一个索引表项就是一条定长记录，因此索引文件可支持随机存取
      - 若索引表按关键字顺序排列，则可支持快速检索
      - 解决了顺序文件不方便增/删记录的问题，同时让不定长记录的文件实现了随机存取。但索引表可能占用很多空间
   - 索引顺序文件
      - 将记录分组，每组对应一个索引表项
      - 检索记录时先顺序查索引表，找到分组，再顺序查找分组
      - 当记录过多时，可建立多级索引表
### 目录结构
> 文件之间应该如何被组织起来

**文件控制块（实现文件目录的关键数据结构）**

- 一个文件对应一个FCB，一个FCB就是一个目录项，多个FCB组成文件目录
- 对目录的操作：搜索、创建文件、删除文件、显示文件、修改文件

**目录结构**

- 单级目录结构
   - 一个系统只有一张目录表，不允许文件重名
- 两级目录结构
   - 不同用户的文件可以重名，但不能对文件进行分类
- 多级目录结构（树形目录结构）
   - 不同目录下的文件可以重名，可以对文件进行分类，不方便文件共享
   - 系统根据“文件路径”找到目标文件
   - 从根目录出发的路径是“绝对路径”
   - 从“当前目录”出发的路径是“相对路径”
- 无环图目录结构
   - 在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个有向无环图
   - 为共享节点设置一个共享计数器，计数器为0时才真正删除该节点

**索引结点（对文件控制块的优化）**

- 除了文件名之外的所有信息都放在索引节点中，每个文件对应一个索引节点
- 目录项中只包含文件名、索引结点指针，因此每个目录项的长度大幅减小
- 由于目录项长度减小，因此每个磁盘块可以存放更多个目录项，因此检索文件时磁盘I/O的次数就少了很多
### 文件的物理结构
> 文件应如何存放在外存中
对非空闲磁盘块的管理（存放了文件数据的磁盘块）

**文件的分配方式**

- 连续分配
- 链接分配
   - 隐式链接
   - 显式链接
- 索引分配
### 存储空间的管理
> 操作系统如何管理外存中的空闲块
对空闲磁盘块的管理

**存储空间的划分与初始化**

- 文件卷（逻辑卷），目录区、文件区的概念
- 目录区包含文件目录、空闲表、位示图、超级块等用于文件管理的数据

**几种管理方法**

- 空闲表法
   - 空闲表中记录每个连续空闲区的起始盘块号、盘块数
   - 分配时可采用首次适应、最佳适应等策略；回收时注意表项合并问题
- 空闲链表法
   - 空闲盘块链
      - 以盘块为单位组成一条空闲链
      - 分配时从链头依次取出空闲块，回收时将空闲块查到链尾
   - 空闲盘区链
      - 以盘区为单位组成一条空闲链
      - 分配时可采用首次适应、最佳适应等策略；回收时注意表项合并问题
- 位示图法
   - 一个二进制对应一个盘块。（字号，位号）或（行号，列号）与盘块号一一对应
- 成组链接法
   - UNIX采用的策略，适合大型文件系统
### 文件共享
**基于索引节点的共享方式（硬链接）**

- 各个用户的目录项指向同一个索引节点
- 索引节点需要有链接计数count
- 某用户想删除文件时，只是删除该用户的目录项，且count--
- 只有count==0时才能真正删除文件数据和索引节点，否则会导致指针悬空

**基于符号链的共享方式（软链接）**

- 在一个Link型文件中记录共享文件的存放路径（Windows快捷方式）
- 操作系统根据路径一层层查找目录，最终找到共享文件
- 即使软链接指向的共享文件已被删除，Link型文件依然存在，只是通过Link型文件中的路径查找共享文件会失败（找不到对应目录项）
- 由于用软链接的方式访问共享文件时要查询多级目录，会有多次I/O，因此用软链接访问
### 文件保护
**口令保护**

- 为文件设置一个“口令”，用户想要访问文件时需要提供口令，由系统验证口令是否正确
- 实现开销小，但“口令”一般存放在FCB或索引节点中（也就是存放在系统中）因此不太安全

**加密保护**

- 用一个“密码”对文件加密，用户想要访问文件时，需要提供相同的“密码”才能正确地解密
- 安全性高，但加密/解密需要耗费一定的时间（Eg：异或加密）

**访问控制**

- 用一个访问控制表（ACL）记录各个用户（或各组用户）对文件的访问权限
- 对文件的访问类型可以分为：读/写/执行/删除 等
- 实现灵活，可以实现复杂的文件保护功能
## 文件系统的层次结构
用户/应用程序
用户接口
文件目录系统
存取控制模块
逻辑文件系统与文件信息缓冲区
物理文件系统
设备管理模块/辅助分配模块
设备

